# AI Agent Contract

Документация JSON-контракта между приложением VitanlyApp и AI-агентом (DeepSeek API).

---

## Обзор

AI-агент получает сообщения пользователя и возвращает структурированный JSON-ответ, содержащий:
- Текстовый ответ для чата
- Распознанные продукты (если пользователь описал еду)
- Команды для выполнения в приложении

---

## Формат ответа AI

```json
{
  "response_text": "Текст ответа для пользователя",
  "food_entries": [
    {
      "name": "Название продукта",
      "weight_g": 100,
      "kcal": 150,
      "protein": 10.0,
      "fat": 5.0,
      "carbs": 15.0
    }
  ],
  "commands": [
    {"type": "command_type", "value": "..."}
  ]
}
```

### Поля

| Поле | Тип | Обязательно | Описание |
|------|-----|-------------|----------|
| `response_text` | string | Да | Текст для отображения в чате |
| `food_entries` | array | Нет | Список распознанных продуктов |
| `commands` | array | Нет | Список команд для выполнения |

---

## Структура FoodEntry

```json
{
  "name": "Яичница из 2 яиц",
  "weight_g": 120,
  "kcal": 180,
  "protein": 12.6,
  "fat": 13.8,
  "carbs": 1.0
}
```

| Поле | Тип | Описание |
|------|-----|----------|
| `name` | string | Название продукта или блюда |
| `weight_g` | int | Вес порции в граммах |
| `kcal` | int | Калории (ккал) |
| `protein` | float | Белки (г) |
| `fat` | float | Жиры (г) |
| `carbs` | float | Углеводы (г) |

---

## Команды агента

### Команды профиля

| Тип | Формат | Описание |
|-----|--------|----------|
| `set_weight` | `{"type": "set_weight", "value": 85.5}` | Установить вес (кг) |
| `set_height` | `{"type": "set_height", "value": 175}` | Установить рост (см) |
| `set_age` | `{"type": "set_age", "value": 30}` | Установить возраст (лет) |
| `set_gender` | `{"type": "set_gender", "value": "male"}` | Установить пол |
| `set_activity` | `{"type": "set_activity", "value": "moderate"}` | Установить активность |

**Значения gender:** `male`, `female`

**Значения activity:** `sedentary`, `light`, `moderate`, `active`, `very_active`

### Команды целей

| Тип | Формат | Описание |
|-----|--------|----------|
| `set_goal` | `{"type": "set_goal", "value": "lose"}` | Установить цель |
| `set_target_weight` | `{"type": "set_target_weight", "value": 80.0}` | Целевой вес (кг) |
| `set_tempo` | `{"type": "set_tempo", "value": 0.5}` | Темп (кг/неделя) |

**Значения goal:** `lose`, `gain`, `maintain`

### Команды еды

| Тип | Формат | Описание |
|-----|--------|----------|
| `add_food` | `{"type": "add_food"}` | Добавить еду из food_entries |
| `delete_food` | `{"type": "delete_food", "name": "Яблоко"}` | Удалить запись по названию |
| `clear_day` | `{"type": "clear_day"}` | Очистить записи за день |

---

## Примеры диалогов

### Добавление еды

**Пользователь:** "Съел яичницу из 2 яиц и тост с маслом"

**AI ответ:**
```json
{
  "response_text": "Записал завтрак! Яичница и тост — отличное начало дня. Всего 350 ккал.",
  "food_entries": [
    {"name": "Яичница из 2 яиц", "weight_g": 120, "kcal": 180, "protein": 12.6, "fat": 13.8, "carbs": 1.0},
    {"name": "Тост с маслом", "weight_g": 45, "kcal": 170, "protein": 3.0, "fat": 8.0, "carbs": 20.0}
  ],
  "commands": [
    {"type": "add_food"}
  ]
}
```

### Изменение параметров

**Пользователь:** "Установи мой вес 90 кг"

**AI ответ:**
```json
{
  "response_text": "Готово! Установил вес 90 кг. Пересчитаю твою норму калорий.",
  "food_entries": [],
  "commands": [
    {"type": "set_weight", "value": 90.0}
  ]
}
```

### Комплексный запрос

**Пользователь:** "Мне 25 лет, рост 180, вес 85, хочу похудеть до 75 за полгода"

**AI ответ:**
```json
{
  "response_text": "Отлично! Записал твои параметры. Чтобы сбросить 10 кг за 6 месяцев, нужен темп примерно 0.4 кг в неделю — это здоровый и устойчивый темп.",
  "food_entries": [],
  "commands": [
    {"type": "set_age", "value": 25},
    {"type": "set_height", "value": 180},
    {"type": "set_weight", "value": 85.0},
    {"type": "set_goal", "value": "lose"},
    {"type": "set_target_weight", "value": 75.0},
    {"type": "set_tempo", "value": 0.4}
  ]
}
```

### Обычный вопрос

**Пользователь:** "Сколько белка в куриной грудке?"

**AI ответ:**
```json
{
  "response_text": "В 100 г куриной грудки (без кожи) примерно 31 г белка, 3.6 г жира и 0 г углеводов. Калорийность — около 165 ккал. Отличный источник белка!",
  "food_entries": [],
  "commands": []
}
```

---

## Расчёт норм КБЖУ

Расчёт выполняется **на стороне приложения** (не AI) по формуле Mifflin-St. Jeor:

**BMR (базовый метаболизм):**
- Мужчины: `10 × вес(кг) + 6.25 × рост(см) - 5 × возраст + 5`
- Женщины: `10 × вес(кг) + 6.25 × рост(см) - 5 × возраст - 161`

**TDEE (суточная норма):**
`BMR × коэффициент_активности`

| Активность | Коэффициент |
|------------|-------------|
| sedentary | 1.2 |
| light | 1.375 |
| moderate | 1.55 |
| active | 1.725 |
| very_active | 1.9 |

**Корректировка по цели:**
- `lose`: TDEE - (темп × 1100) ккал
- `gain`: TDEE + (темп × 1100) ккал
- `maintain`: TDEE

---

## Kotlin модели

Все модели находятся в `domain/model/`:

- `AgentResponse.kt` — структура ответа AI
- `FoodEntry.kt` — запись о еде
- `AgentCommand.kt` — sealed class команд
- `Gender.kt` — enum пола
- `UserGoal.kt` — enum цели
- `ActivityLevel.kt` — enum уровня активности

---

## Важные правила

1. AI **всегда** возвращает `response_text`
2. `food_entries` и `commands` могут быть пустыми массивами
3. Команда `add_food` означает: "добавить все продукты из food_entries"
4. Один день = один цикл подсчёта (данные обнуляются в полночь)
5. БЖУ продуктов берётся из знаний AI (в будущем — внешние базы)
6. Расчёт норм КБЖУ выполняется приложением, не AI
